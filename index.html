<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>地理ツール 安定版</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
    margin:0;
    display:flex;
    height:100vh;
    background:#111;
    color:white;
    font-family:Arial;
}
#sidebar{
    width:220px;
    background:#1a1a1a;
    padding:15px;
}
.modeBtn{
    width:100%;
    padding:10px;
    margin:8px 0;
    background:#222;
    border:none;
    color:white;
    cursor:pointer;
}
#main{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:15px;
}
#map{
    flex:1;
}
.countryItem{
    cursor:pointer;
    padding:5px;
    border-bottom:1px solid #333;
}
.countryItem:hover{
    background:#222;
}
</style>
</head>

<body>

<div id="sidebar">
    <button class="modeBtn" onclick="setMode('country')">国検索</button>
    <button class="modeBtn" onclick="setMode('region')">地域検索</button>
</div>

<div id="main">
    <div id="controls"></div>
    <div id="result"></div>
    <div id="map"></div>
</div>

<script>

let map = L.map('map').setView([20,0],2);
let marker=null;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ISO国コード一覧（安定） */
let countries=[];

async function loadCountries(){
    let res = await fetch("https://api.worldbank.org/v2/country?format=json&per_page=400");
    let data = await res.json();
    countries = data[1].filter(c=>c.region.value!=="Aggregates");
}
loadCountries();

/* モード */
function setMode(mode){

    if(mode==="country"){
        document.getElementById("controls").innerHTML=`
            <input id="countryInput" placeholder="国名入力">
            <button onclick="searchCountry()">検索</button>
            <button onclick="randomCountry()">ランダム</button>
        `;
    }

    if(mode==="region"){
        document.getElementById("controls").innerHTML=`
            <select id="regionSelect">
                <option>Africa</option>
                <option>East Asia & Pacific</option>
                <option>Europe & Central Asia</option>
                <option>Latin America & Caribbean</option>
                <option>Middle East & North Africa</option>
                <option>South Asia</option>
                <option>North America</option>
            </select>
            <button onclick="searchRegion()">表示</button>
        `;
    }

    document.getElementById("result").innerHTML="";
}

/* 国検索 */
function searchCountry(){

    let name=document.getElementById("countryInput").value.toLowerCase();

    let found=countries.find(c=>c.name.toLowerCase().includes(name));
    if(!found){
        document.getElementById("result").innerHTML="見つかりません";
        return;
    }

    showCountry(found);
}

/* ランダム */
function randomCountry(){
    let random=countries[Math.floor(Math.random()*countries.length)];
    showCountry(random);
}

/* 地域検索 */
function searchRegion(){
    let region=document.getElementById("regionSelect").value;

    let filtered=countries.filter(c=>c.region.value===region);

    let html="<div style='max-height:200px;overflow:auto'>";
    filtered.forEach(c=>{
        html+=`<div class="countryItem" onclick="showCountryByCode('${c.id}')">${c.name}</div>`;
    });
    html+="</div>";

    document.getElementById("result").innerHTML=html;
}

/* 表示 */
async function showCountry(country){

    showCountryByCode(country.id);
}

async function showCountryByCode(code){

    let geo = await fetch(`https://restcountries.com/v3.1/alpha/${code}`);
    let data = await geo.json();
    let c = data[0];

    if(marker) map.removeLayer(marker);

    map.setView(c.latlng,5);
    marker=L.marker(c.latlng).addTo(map);

    document.getElementById("result").innerHTML=`
        <h2>${c.name.common}</h2>
        <img src="${c.flags.png}" width="120">
        <p>首都: ${c.capital}</p>
        <p>人口: ${c.population.toLocaleString()}</p>
    `;
}

setMode("country");

</script>
</body>
</html>
