<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>地理お助けツール 安定完全版</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
    margin:0;
    display:flex;
    height:100vh;
    background:#111;
    color:white;
    font-family:Arial;
}
#sidebar{
    width:230px;
    background:#1a1a1a;
    padding:15px;
}
.modeBtn{
    width:100%;
    padding:10px;
    margin:8px 0;
    background:#222;
    border:none;
    color:white;
    cursor:pointer;
}
.modeBtn:hover{
    background:#333;
}
#main{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:15px;
}
#map{
    flex:1;
}
.countryItem{
    cursor:pointer;
    padding:5px;
    border-bottom:1px solid #333;
}
.countryItem:hover{
    background:#222;
}
</style>
</head>

<body>

<div id="sidebar">
    <button class="modeBtn" onclick="setMode('country')">国検索</button>
    <button class="modeBtn" onclick="setMode('region')">地域検索</button>
</div>

<div id="main">
    <div id="controls"></div>
    <div id="result"></div>
    <div id="map"></div>
</div>

<script>

let map = L.map('map').setView([20,0],2);
let marker = null;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let countries=[];

/* 日本語別名辞書 */
const aliasMap = {
    "アメリカ":"USA",
    "米国":"USA",
    "イギリス":"GBR",
    "英国":"GBR",
    "韓国":"KOR",
    "北朝鮮":"PRK",
    "ロシア":"RUS",
    "中国":"CHN",
    "ドイツ":"DEU",
    "フランス":"FRA",
    "日本":"JPN",
    "インド":"IND",
    "ブラジル":"BRA",
    "カナダ":"CAN",
    "オーストラリア":"AUS"
};

/* 世界銀行APIから取得 */
async function loadCountries(){
    let res = await fetch("https://api.worldbank.org/v2/country?format=json&per_page=400");
    let data = await res.json();
    countries = data[1].filter(c=>c.region.value!=="Aggregates");
}
loadCountries();

/* モード切替 */
function setMode(mode){

    if(mode==="country"){
        document.getElementById("controls").innerHTML=`
            <input id="countryInput" placeholder="国名入力">
            <button onclick="searchCountry()">検索</button>
            <button onclick="randomCountry()">ランダム</button>
        `;
    }

    if(mode==="region"){
        document.getElementById("controls").innerHTML=`
            <select id="regionSelect">
                ${[...new Set(countries.map(c=>c.region.value))]
                    .map(r=>`<option>${r}</option>`).join("")}
            </select>
            <button onclick="searchRegion()">表示</button>
        `;
    }

    document.getElementById("result").innerHTML="";
}

/* 国検索 */
function searchCountry(){

    let name = document.getElementById("countryInput").value.trim();
    if(!name) return;

    /* 別名チェック */
    if(aliasMap[name]){
        showCountryByCode(aliasMap[name]);
        return;
    }

    /* 通常検索 */
    let found = countries.find(c =>
        c.name.toLowerCase().includes(name.toLowerCase())
    );

    if(!found){
        document.getElementById("result").innerHTML="見つかりません";
        return;
    }

    showCountry(found);
}

/* ランダム */
function randomCountry(){
    if(countries.length===0) return;
    let random=countries[Math.floor(Math.random()*countries.length)];
    showCountry(random);
}

/* 地域検索 */
function searchRegion(){

    let region=document.getElementById("regionSelect").value;
    let filtered=countries.filter(c=>c.region.value===region);

    let html="<div style='max-height:200px;overflow:auto'>";
    filtered.forEach(c=>{
        html+=`<div class="countryItem" onclick="showCountryByCode('${c.id}')">${c.name}</div>`;
    });
    html+="</div>";

    document.getElementById("result").innerHTML=html;
}

/* 国表示 */
async function showCountry(country){
    showCountryByCode(country.id);
}

async function showCountryByCode(code){

    let geo = await fetch(`https://restcountries.com/v3.1/alpha/${code}`);
    let data = await geo.json();
    let c = data[0];

    if(marker) map.removeLayer(marker);

    map.setView(c.latlng,5);
    marker=L.marker(c.latlng).addTo(map);

    document.getElementById("result").innerHTML=`
        <h2>${c.name.common}</h2>
        <img src="${c.flags.png}" width="120">
        <p>首都: ${c.capital}</p>
        <p>人口: ${c.population.toLocaleString()}</p>
    `;
}

setMode("country");

</script>
</body>
</html>
